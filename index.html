<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <style>
canvas {
  outline: 1px solid rgba(0,0,0,.5);
}
input[type=checkbox] {
  width: 100px; height: 100px;
  outline: 1px solid rgba(0,0,0,.5);
}
    </style>

    <script type="module">
import init, { World } from './pkg/wasm.js';

const $ = q => document.querySelector(q);
const $el = (t, p) => {
  const el = document.createElement(t);
  if (p) for (const [k,v] of Object.entries(p)) el[k] = v;
  return el;
};

function createControl() {
  let control = $el('input', {type:'checkbox'});
  control.addEventListener('change', (e) => {
    if (!control.checked) {
      control.renderLoop();
    }
  });
  return control;
}

async function run() {
  const wasm = await init();
  const [width, height] = [800, 600];
  const numPoints = 30, radius = 10;
  const world = World.new(numPoints, width, height, radius, 2000);

  // Create canvas
  const canvas = $el('canvas');
  document.body.appendChild(canvas);
  canvas.style.width = `${canvas.width = width}px`;
  canvas.style.height = `${canvas.height = height}px`;
  let ctx = canvas.getContext('2d');

  // create control
  let control = createControl();
  document.body.appendChild(control);

  const renderLoop = () => {
    world.step();
    ctx.clearRect(0, 0, width, height);
    const coordsPtr = world.position();
    const coords = new Float32Array(wasm.memory.buffer, coordsPtr, numPoints * 2)

    for (let i = 0; i < 2 * numPoints; i += 2) {
      ctx.beginPath();
      ctx.ellipse(
        // x, y
        coords[i], height - coords[i + 1],
        // radiusX, radiusY
        radius, radius,
        // rotation
        0,
        // startAngle, endAngle
        0, 2 * Math.PI);
      ctx.stroke();
    }
    if (!control.checked) {
      requestAnimationFrame(renderLoop);
    }
  };
  control.renderLoop = renderLoop;
  renderLoop();
}

run();
    </script>
  </head>
  <body></body>
</html>


